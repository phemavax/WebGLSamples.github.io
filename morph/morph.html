<!--
 * Copyright 2010, Google Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Google Inc. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Cantal' rel='stylesheet' type='text/css'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>WebGL Morph</title>
<style>
body {
  width: 100%;
  height: 100%;
  border: 0px;
  padding: 0px;
  margin: 0px;
  background-color: white;
  font-family: sans-serif;
}
CANVAS {
  background-color: gray;
  border: 1px;
}
CANVAS.morph {
  border:1px;
  background-color: black;
}
canvas.slider {
  background-color: blue;
}
td {
  background-color: white;
  text-align: center;
  padding: 3px;
}
td.code {
  background-color: white;
  text-align: left;
}
h1 {
  font-family: 'Cantal', arial, serif;
  text-align: center;
  border-bottom: 1px;
  margin: 2px;
  margin-top: 9px;
  font-size: 48pt;
  text-shadow: 4px 4px 4px #aaa;
}
h3 {
  margin-top: 3px;
  margin-bottom: 2px;
  padding-left: 8px;
}
p.by {
  text-align: center;
}
p {
  margin: 2px;
  margin-bottom: 8px;
}
div.invisible {
  display: none;
}
div.infobox {
  width: 450px;
  margin: 5px;
  margin-top: 12px;
  border-width: 2px;
  border-style: solid;
  border-radius: 10px;
  background-color: #Ffb;
  text-align: left;
  -moz-box-shadow: 3px 3px 3px #aaa;
  -webkit-box-shadow: 3px 3px 3px #aaa;
  box-shadow: 3px 3px 3px #aaa;
}
div.infobox p {
  text-align: left;
  margin: 8px;
}
</style>

<script id="shader-fs" type="x-shader/x-fragment">
  #ifdef GL_ES
  precision highp float;
  #endif
  varying vec2 vTextureCoord1;
  varying vec2 vTextureCoord2;
  uniform sampler2D uSampler1;
  uniform sampler2D uSampler2;
  uniform float fade;

  void main(void) {
    float fade2 = fade;
    vec4 leftColor = texture2D(uSampler1, vec2(vTextureCoord1.s, vTextureCoord1.t));
    vec4 rightColor = texture2D(uSampler2, vec2(vTextureCoord2.s, vTextureCoord2.t));
    // Approximate gamma curve by squaring and taking the root after
    // interpolation. Looks somewhat more natural than a plain lerp.
    gl_FragColor = sqrt(mix(
      leftColor * leftColor, rightColor * rightColor, vec4(fade2, fade2,
      fade2, fade2)));
    // Alternative plane lerp for speed:
    // gl_FragColor = mix(leftColor, rightColor, vec4(fade, fade, fade, fade));
  }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
  attribute vec3 aVertexPosition1;
  attribute vec3 aVertexPosition2;
  attribute vec2 aTextureCoord1;
  attribute vec2 aTextureCoord2;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  uniform float morph;

  varying vec2 vTextureCoord1;
  varying vec2 vTextureCoord2;

  void main(void) {
    float morph2 = morph;
    vec3 vpos = mix(aVertexPosition1, aVertexPosition2, vec3(morph2, morph2,
    morph2));
    vpos.y *= 380.0/300.0;
    gl_Position = uPMatrix * uMVMatrix * vec4(vpos, 1.0);
    vTextureCoord1 = aTextureCoord1;
    vTextureCoord2 = aTextureCoord2;
  }
</script>

<script type="text/javascript"
  src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
</script>
<script type="text/javascript"
  src="morph_editor.js">
</script>
<script type="text/javascript"
  src="sylvester.js">
</script>
<script type="text/javascript"
  src="glUtils.js">
</script>
<script type="text/javascript"
  src="morph_display.js">
</script>
<script type="text/javascript">

defaultFace = [
  {x: 0.5, y: 0.1},
  {x: 0.2, y: 0.2},
  {x: 0.1, y: 0.5},
  {x: 0.2, y: 0.8},
  {x: 0.5, y: 0.9},
  {x: 0.8, y: 0.8},
  {x: 0.9, y: 0.5},
  {x: 0.8, y: 0.2},
  {x: 0.5, y: 0.5},
  {x: 0.4, y: 0.7},
  {x: 0.6, y: 0.7},
  {x: 0.3, y: 0.4},
  {x: 0.7, y: 0.4}
]

bruceFace = [
  {x:0.477, y:0.011},
  {x:0.127, y:0.184},
  {x:0.133, y:0.616},
  {x:0.237, y:0.818},
  {x:0.550, y:0.939},
  {x:0.857, y:0.771},
  {x:0.917, y:0.576},
  {x:0.813, y:0.134},
  {x:0.540, y:0.558},
  {x:0.400, y:0.729},
  {x:0.673, y:0.718},
  {x:0.367, y:0.439},
  {x:0.680, y:0.424},
]

salmaFace = [
  {x:0.417, y:0.082},
  {x:0.107, y:0.245},
  {x:0.123, y:0.603},
  {x:0.197, y:0.818},
  {x:0.483, y:0.963},
  {x:0.763, y:0.818},
  {x:0.800, y:0.568},
  {x:0.747, y:0.192},
  {x:0.470, y:0.674},
  {x:0.347, y:0.766},
  {x:0.633, y:0.745},
  {x:0.307, y:0.516},
  {x:0.627, y:0.497},
]

chuckFace =
[
  {x:0.477, y:0.011},
  {x:0.147, y:0.145},
  {x:0.157, y:0.584},
  {x:0.257, y:0.803},
  {x:0.497, y:0.937},
  {x:0.710, y:0.808},
  {x:0.783, y:0.584},
  {x:0.790, y:0.147},
  {x:0.510, y:0.642},
  {x:0.353, y:0.739},
  {x:0.610, y:0.734},
  {x:0.357, y:0.476},
  {x:0.627, y:0.474},
]

ericFace =
[
  {x:0.493, y:0.055},
  {x:0.153, y:0.203},
  {x:0.097, y:0.605},
  {x:0.203, y:0.805},
  {x:0.497, y:0.937},
  {x:0.793, y:0.797},
  {x:0.877, y:0.632},
  {x:0.820, y:0.216},
  {x:0.510, y:0.642},
  {x:0.333, y:0.729},
  {x:0.633, y:0.745},
  {x:0.353, y:0.500},
  {x:0.663, y:0.513},
]

sergeyFace = 
[
  {x:0.470, y:0.026},
  {x:0.137, y:0.218},
  {x:0.173, y:0.571},
  {x:0.220, y:0.768},
  {x:0.453, y:0.945},
  {x:0.757, y:0.755},
  {x:0.857, y:0.584},
  {x:0.820, y:0.174},
  {x:0.413, y:0.658},
  {x:0.323, y:0.750},
  {x:0.573, y:0.737},
  {x:0.307, y:0.518},
  {x:0.603, y:0.505},
]

keanuFace = 
[
  {x:0.547, y:0.061},
  {x:0.237, y:0.195},
  {x:0.130, y:0.584},
  {x:0.187, y:0.797},
  {x:0.447, y:0.982},
  {x:0.690, y:0.855},
  {x:0.843, y:0.621},
  {x:0.870, y:0.237},
  {x:0.497, y:0.689},
  {x:0.353, y:0.774},
  {x:0.600, y:0.792},
  {x:0.363, y:0.526},
  {x:0.630, y:0.547},
]

faces = {
  "Sergey Brin":  {face: sergeyFace, crop: {}, file: "assets/sergey.jpg"},
  "Keanu Reeves": {face: keanuFace,  crop: {}, file: "assets/keanu.jpg" },
  "Bruce Willis": {face: bruceFace,  crop: {}, file: "assets/bruce.jpg"},
  "Salma Hayek":  {face: salmaFace,  crop: {}, file: "assets/salma.jpg"},
  "Chuck Norris": {face: chuckFace,  crop: {}, file: "assets/chuck.jpg"},
  "Eric Schmidt": {face: ericFace,   crop: {}, file: "assets/eric.jpg"}
}

left_editor   = null
right_editor  = null
morph_display = null
morph_slider  = null

function poplist(list, faces) {
  var i = 0
  for (var name in faces) {
    list.append("<option value='" + i + "'>" + name + "</option>")
    i++
  }
}

function handleChange(select, editor, displayFunc) {
  var value = $(select + " option:selected").text()
  editor.setFace(faces[value].face)
  editor.setImage(faces[value].file)
  displayFunc(faces[value].face, faces[value].file, faces[value].crop)
}

function showExplanation() {
  $('#explanation').toggleClass("invisible")
}

var do_animation = false
var anim_period = 17  // approx. 60 fps
var fakeTime = 0
function animate() {
  if (do_animation) {
    var pos = Math.sin(fakeTime) * 0.5 + 0.5
    fakeTime += 0.014
    morph_slider.setPos(pos)
  }
  setTimeout("animate()", anim_period)
}

$(document).ready(function() {
  poplist($('#left_select'), faces)
  poplist($('#right_select'), faces)
  $('#left_select').val(0)
  $('#right_select').val(4)

  // TODO: Cleanup hacky initialization.
  var left_face = sergeyFace
  left_editor = new MorphEditor('#left', '#left_json', left_face, "assets/sergey.jpg")
  var right_face = chuckFace
  right_editor = new MorphEditor('#right', '#right_json', right_face, "assets/chuck.jpg")

  morph_display = new MorphDisplay('#morph', left_face, right_face, "assets/sergey.jpg",
    "assets/chuck.jpg")

  morph_slider = new Slider('#morph_slider', morph_display)

  $('#left_select').change(function() {
    handleChange('#left_select', left_editor, morph_display.setLeftFace)
  })
  $('#right_select').change(function() {
    handleChange('#right_select', right_editor, morph_display.setRightFace)
  })
  $('#animate').change(function() {
    if ($('#animate').attr('checked')) {
      do_animation = true
      morph_slider.setDraggable(false)
    } else {
      do_animation = false
      morph_slider.setDraggable(true)
    }
  })
  setTimeout("animate()", anim_period)
});

</script>
</head>

<body>
<h1>WebGL Morph</h1>
<center>
<table>
  <tr>
    <td>
      <canvas id="left" width="300" height="380"></canvas>
    </td>
    <td>
      <canvas class="morph" id="morph" width="300" height="380"></canvas>
    </td>
    <td>
      <canvas id="right" width="300" height="380"></canvas>
    </td>
  </tr>
  <tr>
    <td>
      Choose celebrity:
      <select id="left_select">
      </select>
    </td>
    <td><canvas class="slider" id="morph_slider" width="300" height="18"
      style="width:100%;height:100%;"></canvas></td>
    <td>
      Choose celebrity:
      <select id="right_select">
      </select>
    </td>
  </tr>
  <tr>
    <td class="code">
      <div id="left_json" rows=20 style="width:100%;">
    </td>
    <td><b>Check this box:</b>
      <input id="animate" type="checkbox">Animate<br>
      <b>or uncheck and drag the slider!</b>
    </td>

    <td class="code">
      <div id="right_json" rows=20 style="width:100%;">
    </td>
  </tr>
</table>
<div class = "infobox">
  <h3>How does this work? <a href="javascript:showExplanation()">click</a></h3>
  <div class="invisible" id="explanation">
  <p>The two editing panes (and the slider)
  are done with Canvas, while the center morph display
  is drawn using WebGL. Two triangle meshes are constructed from the face
  outlines, with texture coordinates matching the vertex positions, and are then
  linearly interpolated between using a vertex shader, while the fragment (pixel)
  shader interpolates color to create a fade between the two images.</p>
  <p>Yeah, it's really that simple. :-)</p>
  <p>Tested on Chrome 6 for Linux. If you're lucky (and have good drivers) it
  should also work on Windows and MacOSX.</p>
  </div>
</div>
</center>
</body>
</html>


